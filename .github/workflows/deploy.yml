name: CI/CD Pipeline for FastAPI on AKS

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Set AKS context
      uses: azure/aks-set-context@v3
      with:
        resource-group: ${{ secrets.RESOURCE_GROUP }}
        cluster-name: ${{ secrets.CLUSTER_NAME }}
        subscription: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Build Docker image
      run: |
        docker build -t ${{ secrets.REGISTRY_LOGIN_SERVER }}/advancedchatbot:latest .

    - name: Login to ACR
      run: |
        echo ${{ secrets.REGISTRY_PASSWORD }} | docker login ${{ secrets.REGISTRY_LOGIN_SERVER }} -u ${{ secrets.REGISTRY_USERNAME }} --password-stdin

    - name: Push Docker image
      run: |
        docker push ${{ secrets.REGISTRY_LOGIN_SERVER }}/advancedchatbot:latest

    - name: Ensure namespace exists
      run: |
        kubectl create namespace advancedchatbot --dry-run=client -o yaml | kubectl apply -f -

    - name: Apply Kubernetes secret for app
      run: |
        kubectl apply -n advancedchatbot -f - <<EOF
        apiVersion: v1
        kind: Secret
        metadata:
          name: app-secret
          namespace: advancedchatbot
        type: Opaque
        stringData:
          SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        EOF

    - name: Delete old deployments
      run: |
        kubectl delete deploy chatbot-api pdf-chat-assistant pdf-db-assistant --ignore-not-found -n advancedchatbot

    - name: Deploy to AKS (Deployment + Service)
      run: |
        kubectl apply -f deployment.yaml
        kubectl apply -f service.yaml

    - name: Wait for rollout
      run: |
        kubectl -n advancedchatbot rollout status deploy/advancedchatbot --timeout=300s || \
        (echo "Rollout failed, printing pod logs..." && \
         kubectl -n advancedchatbot get pods && \
         kubectl -n advancedchatbot describe deploy advancedchatbot && \
         kubectl -n advancedchatbot logs $(kubectl -n advancedchatbot get pods -l app=advancedchatbot -o jsonpath="{.items[0].metadata.name}") )

    - name: Restart deployment to pick up any changed secrets/image
      run: |
        kubectl -n advancedchatbot rollout restart deploy/advancedchatbot

    - name: Confirm environment variable is present (debug)
      run: |
        POD=$(kubectl -n advancedchatbot get pods -l app=advancedchatbot -o jsonpath="{.items[0].metadata.name}")
        echo "pod: $POD"
        kubectl -n advancedchatbot exec "$POD" -- printenv | grep DATABASE_URL || echo "DATABASE_URL not found in pod env"
